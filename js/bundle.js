(()=>{"use strict";(()=>{const e=e=>{const t=e.getBoundingClientRect();return{top:t.top+pageYOffset,left:t.left+pageXOffset}};window.util={getRandomInt:(e,t)=>(e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e),getCoords:e,getChildElementCoords:(t,o)=>{const n=e(t),i=e(o);return{left:n.left-i.left,top:n.top-i.top}},offersTypes:{flat:"Квартира ",bungalow:"Бунгало ",house:"Дом ",palace:"Дворец "},minPrices:[{type:"flat",minPrice:1e3},{type:"bungalow",minPrice:0},{type:"house",minPrice:5e3},{type:"palace",minPrice:1e4}],possibleFeatures:["wifi","dishwasher","parking","washer","elevator","conditioner"]}})(),window.debounce=e=>{let t=null;return()=>{t&&window.clearTimeout(t),t=window.setTimeout((function(){e()}),500)}},(()=>{const e=(e,t,o,n,i,r,s,a,d=[],l,p=[])=>{const u={};return u.author={avatar:`img/avatars/user0${Number(e)}.png`},u.location={x:window.util.getRandomInt(0+window.map.PIN_WIDTH/2,window.map.pinsContainer.offsetWidth-window.map.PIN_WIDTH/2),y:window.util.getRandomInt(window.map.MAP_MIN_Y,window.map.MAP_MAX_Y)},u.offer={title:String(t),address:String(`${u.location.x}, ${u.location.y}`),price:Number(o),type:String(n),rooms:Number(i),guests:Number(r),checkin:String(s),checkout:String(a),features:d,description:String(l),photos:p},u},t=[];window.data={createAd:e,renderPinsArr:()=>{t.push(e(1,"Лучший дом",8e3,"house",4,12,"12:00","14:00",["wifi","dishwasher","parking","washer","conditioner"],"Описание",["http://o0.github.io/assets/images/tokyo/hotel1.jpg","http://o0.github.io/assets/images/tokyo/hotel2.jpg","http://o0.github.io/assets/images/tokyo/hotel3.jpg"])),t.push(e(2,"Теплый подвальчик",2500,"bungalow",1,2,"13:00","14:00",[],"",["http://o0.github.io/assets/images/tokyo/hotel1.jpg"])),t.push(e(3,"Огромные апартаменты",9e3,"palace",5,15,"12:00","13:00",["wifi","dishwasher","parking","washer","elevator","conditioner"],"Описание",["http://o0.github.io/assets/images/tokyo/hotel1.jpg","http://o0.github.io/assets/images/tokyo/hotel2.jpg","http://o0.github.io/assets/images/tokyo/hotel3.jpg"])),t.push(e(4,"Небольшая комнатка",5700,"flat",1,2,"14:00","14:00",["wifi","dishwasher","parking"],"Описание",[])),t.push(e(5,"Квартира в центре",4e3,"flat",2,3,"12:00","13:00",["parking","washer","conditioner"],"",["http://o0.github.io/assets/images/tokyo/hotel1.jpg","http://o0.github.io/assets/images/tokyo/hotel2.jpg","http://o0.github.io/assets/images/tokyo/hotel3.jpg"])),t.push(e(6,"Очень дешево, ага",7500,"flat",3,6,"13:00","14:00",["parking","washer","elevator"],"Описание",["http://o0.github.io/assets/images/tokyo/hotel2.jpg","http://o0.github.io/assets/images/tokyo/hotel3.jpg"])),t.push(e(7,"Крутой вид из окна",4800,"flat",2,4,"12:00","14:00",["wifi","dishwasher"],"Описание",["http://o0.github.io/assets/images/tokyo/hotel2.jpg","http://o0.github.io/assets/images/tokyo/hotel3.jpg"])),t.push(e(8,"Койка под потолком",3e3,"bungalow",1,1,"14:00","13:00",["wifi","elevator"],"Описание",["http://o0.github.io/assets/images/tokyo/hotel1.jpg"]))},testAds:t}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector("#address"),o=e.querySelector("#title"),n=e.querySelector("#price"),i=e.querySelector("#type"),r=e.querySelector("#room_number"),s=e.querySelector("#capacity"),a=e.querySelector("#timeout"),d=e.querySelector("#timein"),l=e.querySelector("#avatar"),p=e.querySelectorAll(".ad-form__element"),u=document.querySelector(".ad-form__element--time"),c=document.querySelector("#success").content.querySelector(".success"),m=e.querySelector(".ad-form__reset"),w=e.querySelector(".ad-form-header__preview img"),f=()=>{let e=0,t="";for(let o=0;o<window.util.minPrices.length;o++)i.value===window.util.minPrices[o].type&&(e=window.util.minPrices[o].minPrice,t=window.util.offersTypes[window.util.minPrices[o].type]);return{minPrices:e,currentTypes:t}},h=()=>{const e=f().minPrices,t=f().currentTypes;Number(n.value)<e?n.setCustomValidity(`Минимальная цена для ${t} - ${e}`):Number(n.value)>n.max?n.setCustomValidity("Максимальная цена - "+n.max):n.setCustomValidity(""),n.reportValidity()},y=()=>{for(let e of s.children)e.disabled=Number(e.value)>Number(r.value)||"0"===e.value||"100"===r.value},g=t=>{0!==t.button&&"Escape"!==t.key||(e.querySelector(".success").remove(),document.body.style.overflow="visible",document.removeEventListener("keydown",g),document.removeEventListener("mouseup",g))};window.form={checkTitleValidity:()=>{const e=o.minLength,t=o.maxLength,n=o.value.length;n<e?o.setCustomValidity(`Минимум ${e} симв.`):n>t?o.setCustomValidity(`Максимум ${e} симв.`):o.setCustomValidity(""),o.reportValidity()},checkNightPriceValidity:h,onNightPriceChange:()=>{n.placeholder=""+f().minPrices,n.value.length>0&&h()},checkGuestsNumberValidity:()=>{y(),"100"===r.value&&"0"!==s.value?(e.querySelector('#capacity option[value="0"]').disabled=!1,s.setCustomValidity("100 комнат не для гостей")):"100"!==r.value&&"0"===s.value?s.setCustomValidity("А для кого?"):"100"===r.value&&"0"===s.value?(e.querySelector('#capacity option[value="0"]').disabled=!1,s.setCustomValidity("")):Number(s.value)>Number(r.value)?s.setCustomValidity(`${r.value} гостя максимум для ${r.value} комнат`):s.setCustomValidity(""),s.reportValidity()},disableGuestsOptions:y,onSuccessPopupClick:g,checkCheckoutValidity:()=>{d.value!==a.value?a.setCustomValidity(`Если заезд после ${d.value}, то выезд до ${d.value}`):a.setCustomValidity(""),a.reportValidity()},onPictureLoad:e=>{const t=e.target.files[0],o=new FileReader;o.onload=e=>{w.src=e.target.result},o.readAsDataURL(t)},addressInput:t,fieldsets:p,form:e,titleInput:o,nightPriceInput:n,typeInput:i,roomsInput:r,guestsInput:s,checkoutInput:a,checkinInput:d,checkInAndOutFieldset:u,successPopup:c,resetButton:m,userPictureInput:l,userLoadedPicture:w}})(),(()=>{let e="GET";window.load={load:(t,o,n,i,r="")=>{const s=new XMLHttpRequest;s.responseType="json",s.timeout=1e4,s.open(o,t),s.send(r),s.addEventListener("load",(()=>{200===s.status?r?n():n(s.response):i(`Ошибка. Статус ответа: ${s.status} ${s.statusText}`)})),s.addEventListener("timeout",(()=>{i(`Сервер не ответил за ${s.timeout} мс.`)})),s.addEventListener("error",(()=>{i("Произошла ошибка соединения")})),e=r?"POST":"GET"},POST_URL:"https://21.javascript.pages.academy/keksobooking",GET_URL:"https://21.javascript.pages.academy/keksobooking/data",loadType:e,response:[]}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins"),o=document.querySelector("#card").content.querySelector(".map__card"),n=document.querySelector("#error").content.querySelector(".error"),i=document.querySelector(".map"),r=i.querySelector(".map__filters"),s=r.querySelector("#housing-type"),a=r.querySelector("#housing-price"),d=r.querySelector("#housing-rooms"),l=r.querySelector("#housing-guests"),p=r.querySelectorAll(".map__checkbox"),u=(t,o)=>{const n=e.cloneNode(!0),i=n.querySelector("img");return n.style=`left: ${o[t].location.x-25}px; top: ${o[t].location.y-70}px;`,i.src=o[t].author.avatar,i.alt=o[t].offer.title,n},c=e=>{const t=o.cloneNode(!0),n=e.offer.features,i=e.offer.photos;return t.querySelector(".popup__title").textContent=e.offer.title,t.querySelector(".popup__text--address").textContent=e.offer.address,t.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",t.querySelector(".popup__type").textContent=window.util.offersTypes[e.offer.type],t.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`,t.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`,((e,t,o)=>{for(let n=0;n<e.length;n++)t.includes(e[n],0)||o.querySelector(".popup__feature--"+e[n]).remove()})(window.util.possibleFeatures,n,t),t.querySelector(".popup__description").textContent=e.offer.description,((e,t)=>{const o=e.querySelector(".popup__photo");if(0===t.length)return void o.remove();const n=o.cloneNode(!0);o.src=t[0];const i=document.createDocumentFragment();for(let e=1;e<t.length;e++){const o=n.cloneNode(!1);o.src=t[e],i.appendChild(o)}e.querySelector(".popup__photos").appendChild(i)})(t,i),t.querySelector(".popup__avatar").src=e.author.avatar,t},m=(e,t)=>{0!==t.button&&"Escape"!==t.key||(e.removeEventListener("click",m),document.removeEventListener("keyup",m),e.remove())},w=()=>{i.querySelector(".map__card")&&i.querySelector(".map__card").remove()};window.load.load(window.load.GET_URL,"GET",(e=>{window.load.response=e}),(e=>{const o=n.cloneNode(!0),i=o.querySelector(".error__button"),r=document.createElement("button"),s=e=>{0!==e.button&&"Escape"!==e.key||(t.querySelector(".error").remove(),r.removeEventListener("click",s),document.removeEventListener("keyup",s))},a=e=>{s(e),"GET"===window.load.loadType?window.load.load(window.load.GET_URL,"GET",window.map.renderPins,window.map.onErrorGet):window.load.load(window.load.POST_URL,"POST",window.mainPin.onSuccessPost,window.map.onErrorGet,new FormData(window.form.form)),i.removeEventListener("click",a)};o.querySelector(".error__message").textContent=e,i.addEventListener("click",a),r.classList.add("error__button"),r.textContent="Закрыть",r.addEventListener("click",s),document.addEventListener("keyup",s),o.appendChild(r),t.appendChild(o)})),window.map={renderPins:e=>{const o=document.createDocumentFragment();for(let t=0;t<5;t++)try{o.appendChild(u(t,e))}catch(e){break}t.appendChild(o)},renderCardPopup:c,deletePins:()=>{const e=t.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t of e)t.remove()},map:i,pinsContainer:t,MAP_MIN_Y:130,MAP_MAX_Y:630,PIN_HEIGHT:70,PIN_WIDTH:50,typeFilter:s,priceFilter:a,filtersContainer:r,roomsFilter:d,guestsFilter:l,checkboxFilterList:p,renderAdPopup:e=>{if((e.target.classList.contains("map__pin")||e.target.closest(".map__pin:not(.map__pin--main)"))&&!e.target.classList.contains("map__pin--main")){let t;t=e.target.classList.contains("map__pin")?e.target:e.target.closest(".map__pin:not(.map__pin--main)");const o=window.load.response.find((e=>e.location.x-25+"px"===t.style.left&&e.location.y-70+"px"===t.style.top));let n;w(),i.appendChild(c(o)),n=i.querySelector(".map__card"),n.querySelector(".popup__close").addEventListener("click",m.bind(null,n)),document.addEventListener("keyup",m.bind(null,n))}},deleteAdpopup:w}})(),window.pinsFilter={onFilterChange:()=>{let e=window.load.response;const t=t=>{e=e.filter((e=>e.offer.features.includes(t.value)))},o=[{name:window.map.typeFilter,function:()=>{e=e.filter((e=>"any"===window.map.typeFilter.value||window.map.typeFilter.value===e.offer.type))}},{name:window.map.priceFilter,function:()=>{e=e.filter((e=>{switch(window.map.priceFilter.value){case"middle":return e.offer.price>=1e4&&e.offer.price<=5e4;case"low":return e.offer.price<1e4;case"high":return e.offer.price>5e4;default:return!0}}))}},{name:window.map.roomsFilter,function:()=>{e=e.filter((e=>e.offer.rooms===Number(window.map.roomsFilter.value)))}},{name:window.map.guestsFilter,function:()=>{e=e.filter((e=>e.offer.guests===Number(window.map.guestsFilter.value)))}}];for(let e=0;e<o.length;e++)"any"!==o[e].name.value&&o[e].function();for(let e of window.map.checkboxFilterList)e.checked&&t(e);window.map.deletePins(),window.map.renderPins(e)}},(()=>{const e=window.map.pinsContainer.querySelector(".map__pin--main"),t=e.style.left,o=e.style.top,n=()=>{const t=e.offsetWidth,o=window.util.getChildElementCoords(e,window.map.pinsContainer);window.map.map.classList.contains("map--faded")?window.form.addressInput.value=`${Math.round(o.left+t/2)}, ${Math.round(o.top+t/2)}`:window.form.addressInput.value=`${Math.round(o.left+t/2)}, ${Math.round(o.top+window.map.PIN_HEIGHT)}`},i=t=>{0!==t.button&&"Enter"!==t.key||(window.map.renderPins(window.load.response),window.map.map.classList.remove("map--faded"),n(),window.form.disableGuestsOptions(),window.form.form.classList.remove("ad-form--disabled"),r(!1,window.form.fieldsets),window.form.titleInput.addEventListener("input",window.form.checkTitleValidity),window.form.nightPriceInput.addEventListener("input",window.form.checkNightPriceValidity),window.form.typeInput.addEventListener("change",window.form.onNightPriceChange),window.form.roomsInput.addEventListener("change",window.form.checkGuestsNumberValidity),window.form.guestsInput.addEventListener("change",window.form.checkGuestsNumberValidity),window.form.checkInAndOutFieldset.addEventListener("change",window.form.checkCheckoutValidity),window.form.userPictureInput.addEventListener("change",window.form.onPictureLoad),window.form.resetButton.addEventListener("click",a),window.form.form.addEventListener("submit",d),window.map.filtersContainer.addEventListener("change",window.debounce(window.pinsFilter.onFilterChange)),window.map.pinsContainer.addEventListener("click",window.map.renderAdPopup),e.removeEventListener("mousedown",i),e.removeEventListener("keydown",i))},r=(e,t)=>{for(let o of t)o.disabled=e;window.form.form.querySelector(".ad-form-header").disabled=e},s=()=>{const s=window.form.successPopup.cloneNode(!0);document.body.style.overflow="hidden",document.addEventListener("keydown",window.form.onSuccessPopupClick),document.addEventListener("mouseup",window.form.onSuccessPopupClick),window.form.form.appendChild(s),window.form.form.reset(),window.form.userLoadedPicture.src="img/muffin-grey.svg",e.style.left=t,e.style.top=o,n(),window.map.deletePins(),window.map.deleteAdpopup(),window.map.map.classList.add("map--faded"),r(!0,window.form.fieldsets),window.form.form.classList.add("ad-form--disabled"),window.form.titleInput.removeEventListener("input",window.form.checkTitleValidity),window.form.nightPriceInput.removeEventListener("input",window.form.checkNightPriceValidity),window.form.typeInput.removeEventListener("change",window.form.onNightPriceChange),window.form.roomsInput.removeEventListener("change",window.form.checkGuestsNumberValidity),window.form.guestsInput.removeEventListener("change",window.form.checkGuestsNumberValidity),window.form.checkInAndOutFieldset.removeEventListener("change",window.form.checkCheckoutValidity),window.form.userPictureInput.removeEventListener("change",window.form.onPictureLoad),window.form.form.removeEventListener("submit",d),window.form.resetButton.removeEventListener("click",a),window.map.filtersContainer.removeEventListener("change",window.pinsFilter.onFilterChange),window.map.pinsContainer.removeEventListener("click",window.map.renderAdPopup),e.addEventListener("mousedown",i),e.addEventListener("keydown",i)},a=e=>{e.preventDefault(),window.form.form.reset(),n()},d=e=>{window.load.load(window.load.POST_URL,"POST",s,window.map.onErrorGet,new FormData(window.form.form)),e.preventDefault()};n(),r(!0,window.form.fieldsets),e.addEventListener("mousedown",i),e.addEventListener("keydown",i),e.addEventListener("mousedown",(t=>{let o=!1,i="",r={x:t.clientX,y:t.clientY};const s=t=>{const s=r.x-t.clientX,a=r.y-t.clientY;r={x:t.clientX,y:t.clientY};const d=t.pageX-window.util.getCoords(window.map.pinsContainer).left,l=t.pageY-window.util.getCoords(window.map.pinsContainer).top,p=e.offsetLeft-s,u=e.offsetTop-a;if((l<window.map.MAP_MIN_Y-e.offsetWidth||l>window.map.MAP_MAX_Y+e.offsetWidth||d<0||d>window.map.pinsContainer.offsetWidth)&&(o=!0),l<window.map.MAP_MIN_Y-e.offsetWidth)i="top";else if(l>window.map.MAP_MAX_Y+e.offsetWidth)i="bottom";else{if(!(d<0||d>window.map.pinsContainer.offsetWidth))return o&&d>0&&d<window.map.pinsContainer.offsetWidth&&"top"===i?(e.style.left=d-e.offsetWidth/2+"px",e.style.top=l+"px",void(o=!1)):o&&d>0&&d<window.map.pinsContainer.offsetWidth&&"bottom"===i?(e.style.left=d-e.offsetWidth/2+"px",e.style.top=l-e.offsetHeight+"px",void(o=!1)):o&&l>window.map.MAP_MIN_Y-e.offsetWidth&&l<window.map.MAP_MAX_Y+e.offsetWidth&&"left"===i?(e.style.left=d-e.offsetWidth/2+"px",e.style.top=l-e.offsetHeight/2+"px",void(o=!1)):void(p>window.map.pinsContainer.offsetWidth-e.offsetWidth/2||p<0-e.offsetWidth/2||u>window.map.MAP_MAX_Y||u<window.map.MAP_MIN_Y-window.map.PIN_HEIGHT||(e.style.left=p+"px",e.style.top=u+"px",n()));i="left"}},a=()=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",a)})),window.mainPin={onSuccessPost:s}})()})();