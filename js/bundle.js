(()=>{"use strict";(()=>{const e=e=>{const t=e.getBoundingClientRect();return{top:t.top+pageYOffset,left:t.left+pageXOffset}};window.util={getRandomInt:(e,t)=>(e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e),getCoords:e,getChildElementCoords:(t,o)=>{const n=e(t),i=e(o);return{left:n.left-i.left,top:n.top-i.top}},isMouseMainButtonClick:(e,t)=>{0===e.button&&t()},isKeyPressed:(e,t,o)=>{e.key===o&&t()},offersTypes:{flat:"Квартира ",bungalow:"Бунгало ",house:"Дом ",palace:"Дворец "},minPrices:[{type:"flat",minPrice:1e3},{type:"bungalow",minPrice:0},{type:"house",minPrice:5e3},{type:"palace",minPrice:1e4}],possibleFeatures:["wifi","dishwasher","parking","washer","elevator","conditioner"]}})(),window.debounce=e=>{let t=null;return()=>{t&&window.clearTimeout(t),t=window.setTimeout((function(){e()}),500)}},(()=>{const e="100",t="0",o=document.querySelector(".ad-form"),n=o.querySelector("#address"),i=o.querySelector("#title"),r=o.querySelector("#price"),s=o.querySelector("#type"),d=o.querySelector("#room_number"),a=o.querySelector("#capacity"),u=o.querySelector("#timeout"),l=o.querySelector("#timein"),c=o.querySelector("#avatar"),p=o.querySelector("#images"),m=o.querySelectorAll(".ad-form__element"),w=document.querySelector(".ad-form__element--time"),f=document.querySelector("#success").content.querySelector(".success"),y=o.querySelector(".ad-form__reset"),v=o.querySelector(".ad-form-header__preview img"),h=o.querySelector(".ad-form-header__preview--house-picture img"),_=document.querySelector("main"),g=()=>{let e=0,t="";return window.util.minPrices.forEach((o=>{s.value===o.type&&(e=o.minPrice,t=window.util.offersTypes[o.type])})),{minPrices:e,currentTypes:t}},C=()=>{const e=g().minPrices,t=g().currentTypes;Number(r.value)<e?r.setCustomValidity(`Минимальная цена для ${t} - ${e}`):Number(r.value)>r.max?r.setCustomValidity("Максимальная цена - "+r.max):r.setCustomValidity(""),r.reportValidity()},E=()=>{for(let o of a.children)o.disabled=Number(o.value)>Number(d.value)||o.value===t||d.value===e},P=()=>{_.querySelector(".success").remove(),document.body.style.overflow="visible",document.removeEventListener("keydown",S),document.removeEventListener("mouseup",L)},L=e=>{window.util.isMouseMainButtonClick(e,P)},S=e=>{window.util.isKeyPressed(e,P,"Escape")};window.form={onTitleValidityCheck:()=>{const e=i.minLength,t=i.maxLength,o=i.value.length;o<e?i.setCustomValidity(`Минимум ${e} симв.`):o>t?i.setCustomValidity(`Максимум ${e} симв.`):i.setCustomValidity(""),i.reportValidity()},onNightPriceValidityCheck:C,onNightPriceChange:()=>{r.placeholder=""+g().minPrices,r.value.length>0&&C()},onGuestsNumberValidityCheck:()=>{E(),d.value===e&&a.value!==t?(o.querySelector('#capacity option[value="0"]').disabled=!1,a.setCustomValidity("100 комнат не для гостей")):d.value!==e&&a.value===t?a.setCustomValidity("А для кого?"):d.value===e&&a.value===t?(o.querySelector('#capacity option[value="0"]').disabled=!1,a.setCustomValidity("")):Number(a.value)>Number(d.value)?a.setCustomValidity(`${d.value} гостя максимум для ${d.value} комнат`):a.setCustomValidity(""),a.reportValidity()},disableGuestsOptions:E,onSuccessPopupClick:L,onSuccessPopupEscapeDown:S,onCheckoutValidityCheck:()=>{l.value!==u.value?u.setCustomValidity(`Если заезд после ${l.value}, то выезд до ${l.value}`):u.setCustomValidity(""),u.reportValidity()},onPictureLoad:e=>{const t=["gif","jpg","jpeg","png"];return function(o){const n=o.target.files[0];if(t.some((function(e){return n.type.toLowerCase().endsWith(e)}))){const t=new FileReader;t.addEventListener("load",(()=>{e.src=t.result})),t.readAsDataURL(n)}}},resetPreview:()=>{v.src="img/muffin-grey.svg",h.src="img/muffin-grey.svg"},addressInput:n,fieldsets:m,form:o,titleInput:i,nightPriceInput:r,typeInput:s,roomsInput:d,guestsInput:a,checkoutInput:u,checkinInput:l,checkInAndOutFieldset:w,successPopup:f,resetButton:y,userPictureInput:c,userAvatarPicture:v,userHousePicture:h,housePictureInput:p,main:_}})(),(()=>{let e="GET";window.load={load:(t,o,n,i,r="")=>{const s=new XMLHttpRequest;s.responseType="json",s.timeout=1e4,s.open(o,t),s.send(r),s.addEventListener("load",(()=>{200===s.status?r?n():n(s.response):i(`Ошибка. Статус ответа: ${s.status} ${s.statusText}`)})),s.addEventListener("timeout",(()=>{i(`Сервер не ответил за ${s.timeout} мс.`)})),s.addEventListener("error",(()=>{i("Произошла ошибка соединения")})),e=r?"POST":"GET"},POST_URL:"https://21.javascript.pages.academy/keksobooking",GET_URL:"https://21.javascript.pages.academy/keksobooking/data",loadType:e,response:[]}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins"),o=document.querySelector("#card").content.querySelector(".map__card"),n=document.querySelector("#error").content.querySelector(".error"),i=document.querySelector(".map"),r=i.querySelector(".map__filters"),s=r.querySelector("#housing-type"),d=r.querySelector("#housing-price"),a=r.querySelector("#housing-rooms"),u=r.querySelector("#housing-guests"),l=r.querySelectorAll(".map__checkbox"),c=e=>{const t=o.cloneNode(!0),n=e.offer.features,i=e.offer.photos;var r,s,d;return t.querySelector(".popup__title").textContent=e.offer.title,t.querySelector(".popup__text--address").textContent=e.offer.address,t.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",t.querySelector(".popup__type").textContent=window.util.offersTypes[e.offer.type],t.querySelector(".popup__text--capacity").textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей`,t.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`,r=window.util.possibleFeatures,s=n,d=t,r.forEach((e=>{s.includes(e,0)||d.querySelector(".popup__feature--"+e).remove()})),t.querySelector(".popup__description").textContent=e.offer.description,((e,t)=>{const o=e.querySelector(".popup__photo");if(0===t.length)return void o.remove();const n=o.cloneNode(!0);o.src=t[0];const i=document.createDocumentFragment();t.slice(1).forEach((e=>{const t=n.cloneNode(!1);t.src=e,i.appendChild(t)})),e.querySelector(".popup__photos").appendChild(i)})(t,i),t.querySelector(".popup__avatar").src=e.author.avatar,t},p=e=>{e.removeEventListener("click",w),document.removeEventListener("keyup",m),e.remove()},m=e=>t=>{window.util.isKeyPressed(t,p.bind(null,e),"Escape")},w=e=>t=>{window.util.isMouseMainButtonClick(t,p.bind(null,e))},f=()=>{i.querySelector(".map__card")&&i.querySelector(".map__card").remove()};window.load.load(window.load.GET_URL,"GET",(e=>{window.load.response=e}),(e=>{const o=n.cloneNode(!0),i=o.querySelector(".error__button"),r=document.createElement("button"),s=()=>{t.querySelector(".error").remove(),r.removeEventListener("click",a),document.removeEventListener("keyup",d)},d=e=>{window.util.isKeyPressed(e,s,"Escape")},a=e=>{window.util.isMouseMainButtonClick(e,s)},u=()=>{s(),"GET"===window.load.loadType?window.load.load(window.load.GET_URL,"GET",window.map.renderPins,window.map.onErrorGet):window.load.load(window.load.POST_URL,"POST",window.mainPin.onSuccessPost,window.map.onErrorGet,new FormData(window.form.form)),i.removeEventListener("click",u)};o.querySelector(".error__message").textContent=e,i.addEventListener("click",u),r.classList.add("error__button"),r.textContent="Закрыть",r.addEventListener("click",a),document.addEventListener("keyup",d),o.appendChild(r),t.appendChild(o)})),window.map={renderPins:o=>{const n=document.createDocumentFragment();o.slice(0,5).forEach(((t,i)=>{n.appendChild(((t,o)=>{const n=e.cloneNode(!0),i=n.querySelector("img");return n.style=`left: ${o[t].location.x-25}px; top: ${o[t].location.y-70}px;`,i.src=o[t].author.avatar,i.alt=o[t].offer.title,n})(i,o))})),t.appendChild(n)},renderCardPopup:c,deletePins:()=>{const e=t.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t of e)t.remove()},map:i,pinsContainer:t,MAP_MIN_Y:130,MAP_MAX_Y:630,PIN_HEIGHT:70,PIN_WIDTH:50,typeFilter:s,priceFilter:d,filtersContainer:r,roomsFilter:a,guestsFilter:u,checkboxFilterList:l,onAdPopupOpen:e=>{if((e.target.classList.contains("map__pin")||e.target.closest(".map__pin:not(.map__pin--main)"))&&!e.target.classList.contains("map__pin--main")){let t;t=e.target.classList.contains("map__pin")?e.target:e.target.closest(".map__pin:not(.map__pin--main)");const o=window.load.response.find((e=>e.location.x-25+"px"===t.style.left&&e.location.y-70+"px"===t.style.top));let n;f(),i.appendChild(c(o)),n=i.querySelector(".map__card"),n.querySelector(".popup__close").addEventListener("click",w(n)),document.addEventListener("keyup",m(n))}},deleteAdpopup:f}})(),window.pinsFilter={onFilterChange:()=>{let e=window.load.response;const t=t=>{e=e.filter((e=>e.offer.features.includes(t.value)))};[{name:window.map.typeFilter,function:()=>{e=e.filter((e=>"any"===window.map.typeFilter.value||window.map.typeFilter.value===e.offer.type))}},{name:window.map.priceFilter,function:()=>{e=e.filter((e=>{switch(window.map.priceFilter.value){case"middle":return e.offer.price>=1e4&&e.offer.price<=5e4;case"low":return e.offer.price<1e4;case"high":return e.offer.price>5e4;default:return!0}}))}},{name:window.map.roomsFilter,function:()=>{e=e.filter((e=>e.offer.rooms===Number(window.map.roomsFilter.value)))}},{name:window.map.guestsFilter,function:()=>{e=e.filter((e=>e.offer.guests===Number(window.map.guestsFilter.value)))}}].forEach((e=>{"any"!==e.name.value&&e.function()}));for(let e of window.map.checkboxFilterList)e.checked&&t(e);window.map.deletePins(),window.map.renderPins(e)}},(()=>{const e=window.map.pinsContainer.querySelector(".map__pin--main"),t=e.style.left,o=e.style.top,n=()=>{const t=e.offsetWidth,o=window.util.getChildElementCoords(e,window.map.pinsContainer);window.form.addressInput.value=window.map.map.classList.contains("map--faded")?`${Math.round(o.left+t/2)}, ${Math.round(o.top+t/2)}`:`${Math.round(o.left+t/2)}, ${Math.round(o.top+window.map.PIN_HEIGHT)}`},i=()=>{window.map.renderPins(window.load.response),window.map.map.classList.remove("map--faded"),n(),window.form.disableGuestsOptions(),window.form.form.classList.remove("ad-form--disabled"),d(!1,window.form.fieldsets),window.form.titleInput.addEventListener("input",window.form.onTitleValidityCheck),window.form.nightPriceInput.addEventListener("input",window.form.onNightPriceValidityCheck),window.form.typeInput.addEventListener("change",window.form.onNightPriceChange),window.form.roomsInput.addEventListener("change",window.form.onGuestsNumberValidityCheck),window.form.guestsInput.addEventListener("change",window.form.onGuestsNumberValidityCheck),window.form.checkInAndOutFieldset.addEventListener("change",window.form.onCheckoutValidityCheck),window.form.userPictureInput.addEventListener("change",window.form.onPictureLoad(window.form.userAvatarPicture)),window.form.housePictureInput.addEventListener("change",window.form.onPictureLoad(window.form.userHousePicture)),window.form.resetButton.addEventListener("click",a),window.form.form.addEventListener("submit",l),window.map.filtersContainer.addEventListener("change",window.debounce(window.pinsFilter.onFilterChange)),window.map.pinsContainer.addEventListener("click",window.map.onAdPopupOpen),e.removeEventListener("mousedown",r),e.removeEventListener("keydown",s)},r=e=>{window.util.isMouseMainButtonClick(e,i)},s=e=>{window.util.isKeyPressed(e,i,"Enter")},d=(e,t)=>{for(let o of t)o.disabled=e;window.form.form.querySelector(".ad-form-header").disabled=e},a=()=>{window.form.form.reset(),window.map.filtersContainer.reset(),window.form.resetPreview(),e.style.left=t,e.style.top=o,n(),window.map.deletePins(),window.map.deleteAdpopup(),window.map.map.classList.add("map--faded"),d(!0,window.form.fieldsets),window.form.form.classList.add("ad-form--disabled"),window.form.titleInput.removeEventListener("input",window.form.onTitleValidityСheck),window.form.nightPriceInput.removeEventListener("input",window.form.onNightPriceValidityСheck),window.form.typeInput.removeEventListener("change",window.form.onNightPriceChange),window.form.roomsInput.removeEventListener("change",window.form.onGuestsNumberValidityСheck),window.form.guestsInput.removeEventListener("change",window.form.onGuestsNumberValidityСheck),window.form.checkInAndOutFieldset.removeEventListener("change",window.form.onCheckoutValidityСheck),window.form.userPictureInput.removeEventListener("change",window.form.onPictureLoad),window.form.form.removeEventListener("submit",l),window.form.resetButton.removeEventListener("click",a),window.map.filtersContainer.removeEventListener("change",window.pinsFilter.onFilterChange),window.map.pinsContainer.removeEventListener("click",window.map.onAdPopupOpen),e.addEventListener("mousedown",r),e.addEventListener("keydown",s)},u=()=>{const e=window.form.successPopup.cloneNode(!0);document.body.style.overflow="hidden",document.addEventListener("keydown",window.form.onSuccessPopupEscapeDown),document.addEventListener("mouseup",window.form.onSuccessPopupClick),window.form.main.appendChild(e),a()},l=e=>{window.load.load(window.load.POST_URL,"POST",u,window.map.onErrorGet,new FormData(window.form.form)),e.preventDefault()};n(),d(!0,window.form.fieldsets),e.addEventListener("mousedown",r),e.addEventListener("keydown",s),e.addEventListener("mousedown",(t=>{let o=!1,i="",r={x:t.clientX,y:t.clientY};const s=t=>{const s=r.x-t.clientX,d=r.y-t.clientY;r={x:t.clientX,y:t.clientY};const a=t.pageX-window.util.getCoords(window.map.pinsContainer).left,u=t.pageY-window.util.getCoords(window.map.pinsContainer).top,l=e.offsetLeft-s,c=e.offsetTop-d;if((u<window.map.MAP_MIN_Y-e.offsetWidth||u>window.map.MAP_MAX_Y+e.offsetWidth||a<0||a>window.map.pinsContainer.offsetWidth)&&(o=!0),u<window.map.MAP_MIN_Y-e.offsetWidth)i="top";else if(u>window.map.MAP_MAX_Y+e.offsetWidth)i="bottom";else{if(!(a<0||a>window.map.pinsContainer.offsetWidth))return o&&a>0&&a<window.map.pinsContainer.offsetWidth&&"top"===i?(e.style.left=a-e.offsetWidth/2+"px",e.style.top=u+"px",void(o=!1)):o&&a>0&&a<window.map.pinsContainer.offsetWidth&&"bottom"===i?(e.style.left=a-e.offsetWidth/2+"px",e.style.top=u-e.offsetHeight+"px",void(o=!1)):o&&u>window.map.MAP_MIN_Y-e.offsetWidth&&u<window.map.MAP_MAX_Y+e.offsetWidth&&"left"===i?(e.style.left=a-e.offsetWidth/2+"px",e.style.top=u-e.offsetHeight/2+"px",void(o=!1)):void(l>window.map.pinsContainer.offsetWidth-e.offsetWidth/2||l<0-e.offsetWidth/2||c>window.map.MAP_MAX_Y||c<window.map.MAP_MIN_Y-window.map.PIN_HEIGHT||(e.style.left=l+"px",e.style.top=c+"px",n()));i="left"}},d=()=>{document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",d)})),window.mainPin={onSuccessPost:u}})()})();